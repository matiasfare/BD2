CREATE OR REPLACE PACKAGE BODY PCK_PRESTAMO
IS
  FUNCTION F_CALCULAR_CUOTAS(P_MONTO NUMBER, P_TASA NUMBER, 
				P_PLAZO NUMBER, P_FECHA_DES DATE)
	
    RETURN T_CUOTAS IS
    
  		SALDO_CAPITAL_ANT number;
		AMORTIZACION_capital_ant number;
		diferencia number;
		porc_seg_v gen_parametros.porc_seg_vida%type;
		v_cuotas t_cuotas;
    BEGIN

      FOR I IN 1..P_PLAZO LOOP
	SELECT PORC_SEG_VIDA INTO PORC_SEG_V 
		FROM GEN_PARAMETROS;

	IF I= 1 THEN
		V_CUOTAS(I).SALDO_CAPITAL := P_MONTO;
		SALDO_CAPITAL_ANT := V_CUOTAS(I).SALDO_CAPITAL;
		AMORTIZACION_CAPITAL_ANT := P_MONTO/P_PLAZA;
	ELSE
		V_CUOTAS(I).SALDO_CAPITAL := SALDO_CAPITAL_ANT -AMORTIZACION_CAPITAL_ANT;
		SALDO_CAPITAL_ANT := V_CUOTAS(I).SALDO_CAPITAL;
	END IF;
	IF I = P_PLAZO then 
		DIFERENCIA := V_CUOTAS(I).SALDO_CAPITAL - AMORTIZACION_CAPITAL_ANT;
		V_CUOTAS(I).AMORTIZACION := (P_MONTO/P_PLAZO) + DIFERENCIA;
	ELSE 
		V_CUOTAS(I).AMORTIZACION := P_MONTO/P_PLAZO;
	END IF;
	V_CUOTAS(I).INTERES := ((TASA/12)/100)*V_CUOTAS(I).SALDO_CAPITAL;
	V_CUOTAS(I).SEGURO_VIDA := (PORC_SEG_V/100)*V_CUOTAS(I).SALDO_CAPITAL;
	V_CUOTAS(I).MONTO_CUOTA := V_CUOTAS(I).AMORTIZACION + V_CUOTAS(I).INTERES + V_CUOTAS(I).SEGURO_VIDA;
	V_CUOTAS(I).FECHA_VENCIMIENTO := FECHA_D + 30*I; 
      END LOOP;
      	RETURN V_CUOTAS;
    EXCEPTION
      WHEN OTHERS THEN
        e_msg:=SQLERRM;
        RAISE_APPLICATION_ERROR(-20010,'Ha ocurrido un error, verifique el'|| ' mensaje de error: '||'CÃ³digo de error '||e_msg);
        
    END F_CALCULAR_CUOTAS;
    /